{% extends "main/layout.html" %}
{% load static %}

{% block title %}Встановіть новий пароль{% endblock %}

{% block content %}
<div class="login-wrapper">
  <div class="login-card form-wrapper">
    <div class="form-header">
      <img src="{% static 'media/images/olx.svg' %}" alt="Logo" class="form-logo">
      <h3 class="form-title">Встановіть новий пароль</h3>
    </div>

    {% if validlink %}
      <form method="post" id="passwordResetForm" novalidate>
        {% csrf_token %}

        <!-- Новий пароль -->
        <div class="input-group password-field">
          <label for="id_new_password1">Новий пароль</label>
          <div class="password-wrapper">
            <input type="password" name="new_password1" id="id_new_password1" required>
            <i class="bi bi-eye-slash toggle-password" data-target="id_new_password1"></i>
          </div>
          <ul class="password-rules" id="passwordRules">
            <li id="rule-length">Мінімум 8 символів</li>
            <li id="rule-uppercase">Хоча б одна велика літера</li>
            <li id="rule-lowercase">Хоча б одна маленька літера</li>
            <li id="rule-number">Хоча б одна цифра</li>
            <li id="rule-special">Хоча б один спецсимвол (!@#$%^&*)</li>
          </ul>
        </div>

        <!-- Підтвердження пароля -->
        <div class="input-group password-field">
          <label for="id_new_password2">Введіть новий пароль ще раз</label>
          <div class="password-wrapper">
            <input type="password" name="new_password2" id="id_new_password2" required>
            <i class="bi bi-eye-slash toggle-password" data-target="id_new_password2"></i>
          </div>
          <span id="passwordMatch" class="match-status"></span>
        </div>

        <button type="submit" class="submit-btn">Змінити пароль</button>
      </form>

    {% else %}
      <div class="invalid-link">
        <i class="bi bi-exclamation-triangle"></i>
        <p>Посилання для скидання пароля недійсне або вже використане.</p>
        <a href="{% url 'password_reset' %}" class="retry-link">
          <i class="bi bi-arrow-clockwise"></i> Надіслати нове посилання
        </a>
      </div>
    {% endif %}
  </div>
</div>

<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
.password-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}
.password-wrapper input {
  width: 100%;
  padding-right: 35px;
}
.toggle-password {
  position: absolute;
  right: 10px;
  cursor: pointer;
  color: #777;
  font-size: 1.1rem;
  transition: color 0.2s ease;
}
.toggle-password:hover {
  color: #000;
}

.password-rules {
  list-style: none;
  padding: 0;
  margin: 8px 0 0;
  font-size: 0.9rem;
  color: #666;
  text-align: left;
}
.password-rules li::before {
  content: "❌";
  margin-right: 6px;
  color: #d9534f;
}
.password-rules li.valid::before {
  content: "✅";
  color: #198754;
}
.match-status {
  display: block;
  font-size: 0.9rem;
  margin-top: 4px;
}
.match-status.ok { color: #198754; }
.match-status.error { color: #d9534f; }
.submit-btn {
  margin-top: 10px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const password1 = document.getElementById("id_new_password1");
  const password2 = document.getElementById("id_new_password2");
  const matchStatus = document.getElementById("passwordMatch");

  const rules = {
    length: document.getElementById("rule-length"),
    uppercase: document.getElementById("rule-uppercase"),
    lowercase: document.getElementById("rule-lowercase"),
    number: document.getElementById("rule-number"),
    special: document.getElementById("rule-special")
  };

  // ======== Показати/сховати пароль ========
  document.querySelectorAll(".toggle-password").forEach(icon => {
    icon.addEventListener("click", () => {
      const target = document.getElementById(icon.dataset.target);
      const type = target.getAttribute("type") === "password" ? "text" : "password";
      target.setAttribute("type", type);
      icon.classList.toggle("bi-eye");
      icon.classList.toggle("bi-eye-slash");
    });
  });

  // ======== Перевірка правил у реальному часі ========
  password1.addEventListener("input", function() {
    const val = password1.value;
    rules.length.classList.toggle("valid", val.length >= 8);
    rules.uppercase.classList.toggle("valid", /[A-ZА-Я]/.test(val));
    rules.lowercase.classList.toggle("valid", /[a-zа-я]/.test(val));
    rules.number.classList.toggle("valid", /\d/.test(val));
    rules.special.classList.toggle("valid", /[!@#$%^&*]/.test(val));
  });

  // ======== Перевірка збігу паролів ========
  function checkMatch() {
    if (password2.value === "") {
      matchStatus.textContent = "";
      return;
    }
    if (password1.value === password2.value) {
      matchStatus.textContent = "✅ Паролі збігаються";
      matchStatus.className = "match-status ok";
    } else {
      matchStatus.textContent = "❌ Паролі не збігаються";
      matchStatus.className = "match-status error";
    }
  }

  password2.addEventListener("input", checkMatch);

  // Заборонити копіювання/вставку
  ["copy", "paste"].forEach(evt => {
    password2.addEventListener(evt, e => e.preventDefault());
  });
});
</script>
{% endblock %}
