{% extends 'main/layout.html' %}
{% load static widget_tweaks %}

{% block title %}
    {% if is_edit %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid create-ad-container">
    <h1 class="h2 mb-4">
        {% if is_edit %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endif %}
    </h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}

        <!-- === –û–ü–ò–° –¢–ê –¶–Ü–ù–ê === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—à—ñ—Ç—å —É –ø–æ–¥—Ä–æ–±–∏—Ü—è—Ö</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É*</label>
                    {{ form.title }}
                    <div class="form-text">–ù–∞–ø—Ä–∏–∫–ª–∞–¥, iPhone 11 –∑ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é</div>
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.price.id_for_label }}" class="form-label">–¶—ñ–Ω–∞*</label>
                    <div class="input-group">
                        {{ form.price }}
                        <span class="input-group-text">–≥—Ä–Ω</span>
                    </div>
                    {% if form.price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.price.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- === –§–û–¢–û === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–§–æ—Ç–æ (–¥–æ 7 —à—Ç.)</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">–ü–µ—Ä—à–µ —Ñ–æ—Ç–æ –±—É–¥–µ –Ω–∞ –æ–±–∫–ª–∞–¥–∏–Ω—Ü—ñ. –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—è–¥–æ–∫.</p>

                {{ formset.management_form }}

                <div class="row g-3 ad-image-grid">
                    {% for image_form in formset %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="ad-image-placeholder border rounded p-2 text-center position-relative">
                                <label for="{{ image_form.image.id_for_label }}" class="ad-image-label d-block">
                                    {% if image_form.instance.pk and image_form.instance.image %}
                                        <!-- —ñ—Å–Ω—É—é—á–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
                                        <img src="{{ image_form.instance.image.url }}" class="ad-image-preview img-fluid rounded" alt="Preview">
                                        {% if image_form.DELETE %}
                                            <div class="position-absolute top-0 end-0 m-2 bg-white px-2 py-1 rounded small text-danger">
                                                {{ image_form.DELETE }} –í–∏–¥–∞–ª–∏—Ç–∏
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <!-- –ø–æ—Ä–æ–∂–Ω—î –º—ñ—Å—Ü–µ -->
                                        <div class="add-photo-text py-4 text-muted">
                                            <i class="fa-solid fa-camera fa-2x mb-2"></i><br>
                                            <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                                        </div>
                                    {% endif %}
                                    {{ image_form.image }}
                                </label>

                                {% if image_form.image.errors %}
                                    <div class="invalid-feedback d-block mt-1">
                                        {% for error in image_form.image.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}

                                {% if image_form.instance.pk %}
                                    {{ image_form.id }}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- === –û–ü–ò–° === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—Å*</h5>
            </div>
            <div class="card-body">
                {{ form.body }}
                <div class="form-text">–ü–æ–¥—É–º–∞–π—Ç–µ, —â–æ —Ö–æ—Ç—ñ–≤ –±–∏ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø–æ–∫—É–ø–µ—Ü—å.</div>
                {% if form.body.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.body.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- === –ú–Ü–°–¶–ï === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è*</h5>
            </div>
            <div class="card-body">
                {{ form.place }}
                {% if form.place.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.place.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- === –ö–û–ù–¢–ê–ö–¢–ò === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–í–∞—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" value="{{ request.user.email }}" disabled readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
                    <input type="text" class="form-control" value="–í–∞—à –Ω–æ–º–µ—Ä" disabled readonly>
                </div>
            </div>
        </div>

        <!-- === –ö–ù–û–ü–ö–ò === -->
        <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-end gap-2">
                {% if is_edit %}
                    <a href="{% url 'ad_detail' ad.slug %}" class="btn btn-outline-dark btn-lg">–ù–∞–∑–∞–¥</a>
                    <button type="submit" class="btn btn-primary-dark btn-lg">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                {% else %}
                    <a href="#" class="btn btn-outline-dark btn-lg">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</a>
                    <button type="submit" class="btn btn-primary-dark btn-lg">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- === PREVIEW SCRIPT === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const imageInputs = document.querySelectorAll('.ad-image-grid input[type="file"]');

  imageInputs.forEach(input => {
    input.addEventListener('change', e => {
      const file = e.target.files[0];
      const placeholder = input.closest('.ad-image-placeholder');
      const label = placeholder.querySelector('.ad-image-label');

      let preview = label.querySelector('.preview-container');
      if (!preview) {
        preview = document.createElement('div');
        preview.classList.add('preview-container');
        label.insertBefore(preview, input);
      }
      preview.innerHTML = '';

      if (file && (file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name))) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.classList.add('ad-image-preview');
          img.alt = 'Preview';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      } else {
        preview.innerHTML = '<div class="add-photo-text"><i class="fa-solid fa-camera fa-2x mb-2"></i><span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span></div>';
      }
    });
  });
});
</script>
{% endblock %}
