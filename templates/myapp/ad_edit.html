{% extends 'main/layout.html' %}
{% load static widget_tweaks %}

{% block title %}
    {% if is_edit %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid create-ad-container">
    <h1 class="h2 mb-4">
        {% if is_edit %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% else %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endif %}
    </h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}

        <!-- === –û–ü–ò–° –¢–ê –¶–Ü–ù–ê === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—à—ñ—Ç—å —É –ø–æ–¥—Ä–æ–±–∏—Ü—è—Ö</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É*</label>
                    {{ form.title }}
                    <div class="form-text">–ù–∞–ø—Ä–∏–∫–ª–∞–¥, iPhone 11 –∑ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é</div>
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.price.id_for_label }}" class="form-label">–¶—ñ–Ω–∞*</label>
                    <div class="input-group">
                        {{ form.price }}
                        <span class="input-group-text">–≥—Ä–Ω</span>
                    </div>
                    {% if form.price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.price.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>



        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–§–æ—Ç–æ (–¥–æ 7 —à—Ç.)</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">–ü–µ—Ä—à–µ —Ñ–æ—Ç–æ –±—É–¥–µ –Ω–∞ –æ–±–∫–ª–∞–¥–∏–Ω—Ü—ñ. –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—è–¥–æ–∫.</p>

                {{ formset.management_form }}

                {% if formset.non_form_errors %}
                    <div class="alert alert-danger">
                        {% for error in formset.non_form_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row g-3 ad-image-grid">
                    {% for image_form in formset %}
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="ad-image-placeholder border rounded p-2 text-center position-relative">

                                <label for="{{ image_form.image.id_for_label }}" class="ad-image-label d-block">
                                    {% if image_form.instance.pk and image_form.instance.image %}
                                        <img src="{{ image_form.instance.image.url }}" class="ad-image-preview img-fluid rounded" alt="Preview">
                                    {% else %}
                                        <div class="add-photo-text py-4 text-muted">
                                            <i class="fa-solid fa-camera fa-2x mb-2"></i><br>
                                            <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                                        </div>
                                    {% endif %}
                                </label>



                                {% render_field image_form.image class+="ad-image-input-hidden" %}


                                {% if image_form.image.errors %}
                                    <div class="invalid-feedback d-block mt-1">
                                        {% for error in image_form.image.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}

                                {% if image_form.instance.pk %}
                                    {{ image_form.id }}
                                {% endif %}

                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- === –û–ü–ò–° === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—Å*</h5>
            </div>
            <div class="card-body">
                {{ form.body }}
                <div class="form-text">–ü–æ–¥—É–º–∞–π—Ç–µ, —â–æ —Ö–æ—Ç—ñ–≤ –±–∏ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø–æ–∫—É–ø–µ—Ü—å.</div>
                {% if form.body.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.body.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- === –ú–Ü–°–¶–ï === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è*</h5>
            </div>
            <div class="card-body">
                {{ form.place }}
                {% if form.place.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.place.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- === –ö–û–ù–¢–ê–ö–¢–ò === -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–í–∞—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" value="{{ request.user.email }}" disabled readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
                    <input type="text" class="form-control" value="–í–∞—à –Ω–æ–º–µ—Ä" disabled readonly>
                </div>
            </div>
        </div>

        <!-- === –ö–ù–û–ü–ö–ò === -->
        <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-end gap-2">
                {% if is_edit %}
                    <a href="{% url 'ad_detail' ad.slug %}" class="btn btn-outline-dark btn-lg">–ù–∞–∑–∞–¥</a>
                    <button type="submit" class="btn btn-primary-dark btn-lg">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                {% else %}
                    <a href="#" class="btn btn-outline-dark btn-lg">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</a>
                    <button type="submit" class="btn btn-primary-dark btn-lg">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- === PREVIEW SCRIPT === -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // === –û–±—Ä–æ–±–Ω–∏–∫ –¢–Ü–õ–¨–ö–ò –î–õ–Ø –ü–†–ï–í'–Æ –∑–æ–±—Ä–∞–∂–µ–Ω—å ===
    const imageInputs = document.querySelectorAll('.ad-image-grid input[type="file"]');

    imageInputs.forEach(input => {
        input.addEventListener('change', e => {
            const file = e.target.files[0];
            const label = input.closest('.ad-image-label'); // –ó–Ω–∞—Ö–æ–¥–∏–º–æ <label>
            if (!label) return;

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç "–î–æ–¥–∞—Ç–∏" –∞–±–æ —Å—Ç–∞—Ä–µ —Ñ–æ—Ç–æ)
            const addPhotoText = label.querySelector('.add-photo-text');
            const existingPreview = label.querySelector('.ad-image-preview');

            // –®—É–∫–∞—î–º–æ/—Å—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ (–∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ) –ø—Ä–µ–≤'—é
            let clientPreviewWrapper = label.querySelector('.client-preview-wrapper');
            if (!clientPreviewWrapper) {
                clientPreviewWrapper = document.createElement('div');
                clientPreviewWrapper.classList.add('client-preview-wrapper');
                label.prepend(clientPreviewWrapper); // –í—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ <label>
            }


            if (file && file.type.startsWith('image/')) {
                // --- 1. –§–∞–π–ª –æ–±—Ä–∞–Ω–æ ---

                // –•–æ–≤–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                if (addPhotoText) addPhotoText.style.display = 'none';
                if (existingPreview) existingPreview.style.display = 'none';

                // –ì–µ–Ω–µ—Ä—É—î–º–æ —ñ –ø–æ–∫–∞–∑—É—î–º–æ –Ω–æ–≤–µ –ø—Ä–µ–≤'—é
                const reader = new FileReader();
                reader.onload = ev => {
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–µ –ø—Ä–µ–≤'—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –æ–±–≥–æ—Ä—Ç–∫–∏
                    clientPreviewWrapper.innerHTML = `<img src="${ev.target.result}" class="ad-image-preview img-fluid rounded" alt="New Preview">`;
                };
                reader.readAsDataURL(file);

            } else {
                // --- 2. –§–∞–π–ª –ù–ï –æ–±—Ä–∞–Ω–æ (–∞–±–æ —Å–∫–∞—Å–æ–≤–∞–Ω–æ) ---

                // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–≤'—é
                clientPreviewWrapper.innerHTML = '';

                // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                if (addPhotoText) addPhotoText.style.display = 'block';
                if (existingPreview) existingPreview.style.display = 'block';
            }
        });
    });

    // –í—Å—è –ª–æ–≥—ñ–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í–∏–¥–∞–ª–∏—Ç–∏" (—ñ —Å—Ç–∞—Ä–∞, —ñ –Ω–æ–≤–∞) –≤–∏–¥–∞–ª–µ–Ω–∞.

});
</script>
{% endblock %}
