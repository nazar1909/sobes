{% extends 'main/layout.html' %}
{% load static %}

{% block title %}–í—Å—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endblock %}

{% block content %}
<div class="container-fluid">

    <h1 class="h2 mb-4">–í—Å—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h1>

    <div class="profile-ads-container">

        {% if ads %}
            {% for ad in ads %}

            <div class="card shadow-sm ad-management-card mb-3 position-relative">
                <div class="row g-0">

                    <div class="col-md-3 position-relative">


                        {% if ad.images.exists %}
                            <img src="{{ ad.images.first.image.url }}"
                                 alt="{{ ad.title }}"
                                 class="ad-management-img rounded-start">
                        {% else %}
                            <img src="{% static 'media/images/placeholder.png' %}"
                                 alt="–ù–µ–º–∞—î —Ñ–æ—Ç–æ"
                                 class="ad-management-img rounded-start">
                        {% endif %}
                    </div>

                    <div class="col-md-9">
                        <div class="card-body position-relative h-100 d-flex flex-column">

                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">
                                    <a href="{% url 'ad_detail' slug=ad.slug %}" class="stretched-link text-decoration-none text-dark">
                                        {{ ad.title }}
                                    </a>
                                </h5>
                                <h5 class="ad-price text-dark fw-bold mb-0 ms-3">{{ ad.price|floatformat:0 }} –≥—Ä–Ω</h5>
                            </div>


                            <div class="mt-auto">
                                <p class="card-text small text-muted mb-0 mt-2">
                                    <i class="fa-solid fa-location-dot me-1"></i> {{ ad.place|default:"–ú—ñ—Å—Ü–µ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ" }}
                                    <span class="mx-2">‚Ä¢</span>
                                    <i class="fa-regular fa-calendar-days me-1"></i> {{ ad.date|date:"d M Y" }}
                                </p>
                            </div>


                            {% if user.is_authenticated and ad.user != user %}

                            <a href="{% url 'toggle_favorite' slug=ad.slug %}"
                               class="favorite-icon position-absolute bottom-0 end-0 m-2"
                               onclick="event.preventDefault(); toggleFavorite('{{ ad.slug }}');">
                                <i id="heart-{{ ad.slug }}"
                                   class="fa{% if user in ad.favorites.all %}-solid{% else %}-regular{% endif %} fa-heart"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% endfor %}
        {% else %}
            <div class="text-center p-5 bg-light rounded">
                <h3>–û–≥–æ–ª–æ—à–µ–Ω—å —â–µ –Ω–µ–º–∞—î</h3>
                <p class="lead text-muted">–ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –¥–æ–¥–∞—Å—Ç—å –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è!</p>
                <a href="{% url 'ad_create' %}" class="btn btn-primary-dark btn-lg mt-3">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
                </a>
            </div>
        {% endif %}
    </div>

</div>
<script>
function getCSRFToken() {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

async function toggleFavorite(slug) {
    try {
        const response = await fetch(`/toggle-favorite/${slug}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.success) {
            const heartIcon = document.getElementById(`heart-${slug}`);
            const favCountElem = document.getElementById('favorite-count');
            const favLink = document.getElementById('favorite-link');

            // ‚ù§Ô∏è –Ü–∫–æ–Ω–∫–∞
            if (data.is_favorite) {
                heartIcon.classList.remove('fa-regular');
                heartIcon.classList.add('fa-solid');
                heartIcon.style.color = '#ff4b6e';
            } else {
                heartIcon.classList.add('fa-regular');
                heartIcon.classList.remove('fa-solid');
                heartIcon.style.color = '';
            }

            // üî¢ –õ—ñ—á–∏–ª—å–Ω–∏–∫
            if (favCountElem) {
                favCountElem.textContent = data.favorite_count;
                favCountElem.classList.toggle('d-none', data.favorite_count === 0);
            }

            // ‚ú® –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–æ–≤–µ –¥–æ–¥–∞–Ω–æ)
            if (favLink) {
                if (data.is_favorite && !window.location.pathname.includes("favorite_ads")) {
                    // –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–æ–¥–∞–≤ –Ω–æ–≤–µ ‚Äî –∑–Ω–æ–≤—É –¥–æ–∑–≤–æ–ª—è—î–º–æ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏
                    localStorage.setItem('favoritesViewed', 'false');
                    favLink.classList.add('favorite-link-active');
                }

                if (data.favorite_count === 0) {
                    favLink.classList.remove('favorite-link-active');
                    favCountElem.classList.add('d-none');
                }
            }

            showToast(
                data.is_favorite
                    ? `üíñ –î–æ–¥–∞–Ω–æ –¥–æ –æ–±—Ä–∞–Ω–∏—Ö (${data.favorite_count})`
                    : `‚ùå –í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–∏—Ö`
            );
        }

    } catch (error) {
        console.error('Error:', error);
    }
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.className = 'favorite-toast';
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 50);
    setTimeout(() => toast.classList.remove('show'), 2500);
    setTimeout(() => toast.remove(), 3000);
}

// üß† –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener("DOMContentLoaded", function () {
    const favLink = document.getElementById("favorite-link");
    const favCount = document.getElementById("favorite-count");
    const currentPath = window.location.pathname;

    // 1Ô∏è‚É£ –Ø–∫—â–æ –º–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –æ–±—Ä–∞–Ω–∏—Ö
    if (currentPath.includes("favorite-ads")) {
        console.log("ü©∑ –í–ø–æ–¥–æ–±–∞–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ ‚Äî –≥–∞—Å–∏–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ 0.5—Å");

        setTimeout(() => {
            if (favLink) favLink.classList.remove("favorite-link-active");
            if (favCount) favCount.classList.add("d-none");

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–∫—Ç, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–∂–µ –±–∞—á–∏–≤ –æ–±—Ä–∞–Ω—ñ
            localStorage.setItem("favorites_viewed", "true");
            console.log("üíæ favorites_viewed = true");
        }, 500);

        return; // ‚õî –±—ñ–ª—å—à–µ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–∏–∫–æ–Ω—É—î–º–æ
    }

    // 2Ô∏è‚É£ –Ø–∫—â–æ –º–∏ –ù–ï –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –æ–±—Ä–∞–Ω–∏—Ö
    const hasViewedFavorites = localStorage.getItem("favorites_viewed") === "true";

    if (favLink && favCount) {
        // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —â–µ –Ω–µ –∑–∞—Ö–æ–¥–∏–≤ —É "–û–±—Ä–∞–Ω–µ" ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥—Å–≤—ñ—á–µ–Ω–Ω—è
        if (!hasViewedFavorites && parseInt(favCount.textContent) > 0) {
            favLink.classList.add("favorite-link-active");
            favCount.classList.remove("d-none");
        } else {
            // –Ø–∫—â–æ –≤–∂–µ –∑–∞—Ö–æ–¥–∏–≤ ‚Äî –ø—Ä–∏–±–∏—Ä–∞—î–º–æ
            favLink.classList.remove("favorite-link-active");
            favCount.classList.add("d-none");
        }
    }

    // 3Ô∏è‚É£ –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–æ–¥–∞—î/–≤–∏–¥–∞–ª—è—î —â–æ—Å—å ‚Äî —Å–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω
    document.querySelectorAll(".favorite-icon").forEach(btn => {
        btn.addEventListener("click", () => {
            localStorage.removeItem("favorites_viewed");
            console.log("‚ôªÔ∏è favorites_viewed —Å–∫–∏–Ω—É—Ç–æ ‚Äî –Ω–æ–≤–∞ –¥—ñ—è");
        });
    });
});

// üîî –°—Ç–∏–ª—ñ
const style = document.createElement('style');
style.innerHTML = `
.favorite-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #3a1a30;
  color: #fff;
  padding: 10px 16px;
  border-radius: 12px;
  opacity: 0;
  transition: all .3s ease-in-out;
  z-index: 9999;
}
.favorite-toast.show {
  opacity: 1;
  transform: translateY(-10px);
}
`;
document.head.appendChild(style);
</script>







{% endblock %}
