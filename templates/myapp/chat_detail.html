{% extends "main/layout.html" %}
{% load static %}

{% block content %}
<script id="chat-script"
        data-chat-id="{{ room_name_json }}"
        data-user-avatar="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}https://res.cloudinary.com/dhact88gj/image/upload/xoe34jkbrrv8lr7mfpk8{% endif %}"
        defer>
    // –°—é–¥–∏ –±—É–¥–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–∏–π –≤–∞—à JavaScript
</script>

<div class="chat-container">

    <div class="chat-header">

        <div class="chat-header-info">
            <h3>–ß–∞—Ç –∑ {{ other_user.username }}</h3>
            <p>—â–æ–¥–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è: **{{ chat_room.ad.title }}**</p>
        </div>

        <a href="{% url 'chat_list' %}" class="chat-back-link">
            <i class="fas fa-arrow-left me-1"></i> –ù–∞–∑–∞–¥ –¥–æ –≤—Å—ñ—Ö —á–∞—Ç—ñ–≤
        </a>
    </div>

    <a href="{% url 'ad_detail' slug=chat_room.ad.slug %}" class="text-decoration-none">
        <div class="card ad-listing-card mb-0 shadow-sm" style="border-radius: 0; border: none; border-bottom: 1px solid #e9ecef;">
            <div class="row g-0">
                <div class="col-3">
                    <img src="{% if chat_room.ad.images.first %}{{ chat_room.ad.images.first.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="ad-listing-img"
                         style="height: 100%; border-radius: 0; object-fit: cover;" alt="{{ chat_room.ad.title }}">
                </div>
                <div class="col-9">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h5 class="card-title mb-0">
                                <span class="text-dark">
                                    {{ chat_room.ad.title|truncatechars:35 }}
                                </span>
                            </h5>
                            <h4 class="text-dark fw-bold mb-0 ms-2" style="font-size: 1rem;">
                                {{ chat_room.ad.price|floatformat:0 }} –≥—Ä–Ω
                            </h4>
                        </div>
                        <p class="card-text text-muted small mb-0">
                            <i class="fa-solid fa-location-dot me-1"></i>
                            {{ chat_room.ad.place|default:"–ú—ñ—Å—Ü–µ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ" }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </a>

    <div class="message-list" id="message-list">
        {% for message in messages %}
            {% if message.sender == request.user %}
                <div class="message-row sent" data-message-id="{{ message.id }}">
                    <div class="message sent">
                        {% if message.file %}
                            {% with filename=message.file.name|default:"–§–∞–π–ª" %}
                                {% if filename|lower|slice:"-4:" == ".jpg" or filename|lower|slice:"-5:" == ".jpeg" or filename|lower|slice:"-4:" == ".png" or filename|lower|slice:"-4:" == ".gif" %}
                                    <a href="{{ message.file.url }}" target="_blank">
                                        <img src="{{ message.file.url }}" class="chat-message-image" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è">
                                    </a>
                                {% else %}
                                    <a href="{{ message.file.url }}" target="_blank" class="file-link">
                                        <i class="fas fa-file me-2"></i> [–§–∞–π–ª: {{ filename|slice:"-20:" }}]
                                    </a>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        {% if message.content %}<p>{{ message.content }}</p>{% endif %}
                        <span class="timestamp">{{ message.timestamp|date:"d.m H:i" }}</span>
                    </div>

                    <img src="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="chat-avatar profile-trigger"
                         alt="Avatar"
                         data-username="{{ request.user.username }}"
                         data-avatar-url="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         data-bio="{{ request.user.profile.bio|default:'' }}"
                         data-phone="{{ request.user.profile.phone|default:'' }}"
                         data-profile-url="{% url 'my_profile' %}">
                </div>

            {% else %}
                <div class="message-row received" data-message-id="{{ message.id }}">

                    <img src="{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="chat-avatar profile-trigger"
                         alt="Avatar"
                         data-username="{{ other_user.username }}"
                         data-avatar-url="{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         data-bio="{{ other_user.profile.bio|default:'' }}"
                         data-phone="{{ other_user.profile.phone|default:'' }}"
                         data-profile-url="{% url 'public_profile' username=other_user.username %}">

                    <div class="message received">
                        <strong>{{ message.sender.username }}:</strong>
                        {% if message.file %}
                            {% with filename=message.file.name|default:"–§–∞–π–ª" %}
                                {% if filename|lower|slice:"-4:" == ".jpg" or filename|lower|slice:"-5:" == ".jpeg" or filename|lower|slice:"-4:" == ".png" or filename|lower|slice:"-4:" == ".gif" %}
                                    <a href="{{ message.file.url }}" target="_blank">
                                        <img src="{{ message.file.url }}" class="chat-message-image" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è">
                                    </a>
                                {% else %}
                                    <a href="{{ message.file.url }}" target="_blank" class="file-link">
                                        <i class="fas fa-file me-2"></i> [–§–∞–π–ª: {{ filename|slice:"-20:" }}]
                                    </a>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        {% if message.content %}<p>{{ message.content }}</p>{% endif %}
                        <span class="timestamp">{{ message.timestamp|date:"d.m H:i" }}</span>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="chat-input-area">
        <form id="message-form" class="message-form" enctype="multipart/form-data">
            {% csrf_token %}



            <div class="message-input-wrapper">
                <div id="file-preview" class="file-preview-inline"></div>

                <textarea id="message-input" name="content" class="form-control" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
            </div>

            <div class="message-form-right-controls">

                <button type="submit" class="icon-btn send-btn">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </form>
    </div>

</div>

<div id="profilePopup" class="profile-popup-overlay" style="display: none;">
  <div class="edit-profile-card fade-in">
    <h2><i class="fa-solid fa-user" style="color: #3a1a30"></i> –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
    <div class="profile-view">
      <div class="avatar-section">
        <img src="" id="popup-avatar" class="profile-avatar-preview" alt="Avatar">
      </div>
      <div class="form-group">
        <label>–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
        <p id="popup-username"></p>
      </div>
      <div class="form-group" id="popup-bio-wrapper" style="display: none;">
        <label>–ü—Ä–æ —Å–µ–±–µ</label>
        <p id="popup-bio"></p>
      </div>
      <div class="form-group" id="popup-phone-wrapper" style="display: none;">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <p id="popup-phone"></p>
      </div>
      <div class="profile-buttons">
          <a href="#" id="popup-profile-link" class="btn btn-secondary">
              <i class="fa-solid fa-user-circle"></i> –ü–æ–≤–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
          </a>
          <button id="closeProfileBtn" class="btn btn-gradient">
              <i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥
          </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // ============================================================
    // 0. –ì–û–õ–û–í–ù–Ü –ó–ú–Ü–ù–ù–Ü
    // ============================================================
    const scriptTag = document.getElementById("chat-script");
    const chatId = scriptTag.dataset.chatId; // –¢—É—Ç –º–∞—î –±—É—Ç–∏ "1-4"
    const userAvatar = scriptTag.dataset.userAvatar;

    const messageList = document.getElementById("message-list");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.querySelector(".send-btn");

    // –î–∞–Ω—ñ —é–∑–µ—Ä–∞
    const currentUser = {
        username: "{{ request.user.username }}",
        avatar: userAvatar,
        bio: "{{ request.user.profile.bio|default:'' }}",
        phone: "{{ request.user.profile.phone|default:'' }}",
        url: "{% url 'my_profile' %}"
    };

    // –î–∞–Ω—ñ —ñ–Ω—à–æ–≥–æ —é–∑–µ—Ä–∞
    const otherUser = {
        username: "{{ other_user.username }}",
        avatar: "{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}https://res.cloudinary.com/dhact88gj/image/upload/xoe34jkbrrv8lr7mfpk8{% endif %}",
        bio: "{{ other_user.profile.bio|default:'' }}",
        phone: "{{ other_user.profile.phone|default:'' }}",
        url: "{% url 'public_profile' username=other_user.username %}"
    };

    // ============================================================
    // üöÄ 1. WEBSOCKET –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø (DAPHNE)
    // ============================================================
    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(wsProtocol + window.location.host + '/ws/chat/' + chatId + '/');

    chatSocket.onopen = function(e) {
        console.log("‚úÖ Chat Socket Connected to room:", chatId);
    };

    chatSocket.onclose = function(e) {
        console.error("‚ö†Ô∏è Chat Socket Closed", e);
    };

    // üì© –û–ë–†–û–ë–ö–ê –í–•–Ü–î–ù–ò–• –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // üõ†Ô∏è –î–û–ü–û–ú–Ü–ñ–ù–ê –õ–û–ì–Ü–ö–ê –î–õ–Ø –ê–í–ê–¢–ê–†–û–ö
        // –ú–∏ –≤–∏–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∞–≤–∞—Ç–∞—Ä —Ç—É—Ç, —â–æ–± –Ω–µ –∑–∞–ª–µ–∂–∞—Ç–∏ –≤—ñ–¥ —Ç–æ–≥–æ, —â–æ –ø—Ä–∏—Å–ª–∞–≤ —Å–æ–∫–µ—Ç
        function getCorrectAvatar(isMe) {
            return isMe ? currentUser.avatar : otherUser.avatar;
        }

        // A. –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ)
        if (data.type === 'chat_history' && data.messages) {
            messageList.innerHTML = ''; // –ß–∏—Å—Ç–∏–º–æ —Å–ø–∏—Å–æ–∫
            data.messages.forEach(msg => {
                const isMe = msg.username === currentUser.username;

                const msgData = {
                    id: Date.now() + Math.random(),
                    is_me: isMe,
                    sender: msg.username,

                    // üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ë–µ—Ä–µ–º–æ –Ω–∞—à –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∞–≤–∞—Ç–∞—Ä, –∞ –Ω–µ msg.avatar_url
                    avatar: getCorrectAvatar(isMe),

                    content: msg.message,
                    timestamp: msg.timestamp,
                    // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–ª—è
                    bio: isMe ? currentUser.bio : otherUser.bio,
                    phone: isMe ? currentUser.phone : otherUser.phone,
                    profile_url: isMe ? currentUser.url : otherUser.url
                };

                if (isMe) appendSentMessage(msgData);
                else appendIncomingMessage(msgData);
            });
            scrollToBottom();
        }

        // B. –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ)
        else if (data.type === 'new_message') {
            const isMe = data.username === currentUser.username;

            // –ú–∞–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –ß–£–ñ–Ü –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Å–≤–æ—ó –º–∏ –≤–∂–µ –Ω–∞–º–∞–ª—é–≤–∞–ª–∏ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ)
            if (!isMe) {
                const msgData = {
                    id: Date.now(),
                    is_me: false,
                    sender: data.username,

                    // üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –¢—É—Ç —Ç–µ–∂ —Ñ–æ—Ä—Å—É—î–º–æ –∞–≤–∞—Ç–∞—Ä —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞
                    avatar: otherUser.avatar,

                    content: data.message,
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    bio: otherUser.bio,
                    phone: otherUser.phone,
                    profile_url: otherUser.url
                };
                appendIncomingMessage(msgData);
            }
        }
    };

    // ============================================================
    // üì§ 2. –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (–ß–ï–†–ï–ó –°–û–ö–ï–¢)
    // ============================================================
    if (messageForm) {
        messageForm.addEventListener("submit", e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;

            if (chatSocket.readyState === WebSocket.OPEN) {
                // 1. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                chatSocket.send(JSON.stringify({
                    'message': text
                }));

                // 2. –ú–∞–ª—é—î–º–æ —É —Å–µ–±–µ –º–∏—Ç—Ç—î–≤–æ (Optimistic UI)
                appendSentMessage({
                    id: Date.now(),
                    content: text,
                    timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });

                // 3. –ß–∏—Å—Ç–∏–º–æ –ø–æ–ª–µ
                messageInput.value = "";
                updateMessageInputHeight();
            } else {
                console.error("Socket is not open");
                alert("–ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
            }
        });
    }

    // ============================================================
    // 3. –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á UI (–¢–≤—ñ–π –∫–æ–¥)
    // ============================================================

    function scrollToBottom() {
        messageList.scrollTop = messageList.scrollHeight;
    }

    function updateMessageInputHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
        messageInput.style.paddingTop = "8px";
    }

    messageInput.addEventListener('input', updateMessageInputHeight);

    // –û–±—Ä–æ–±–∫–∞ Enter
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (e.shiftKey || e.ctrlKey) return;
            e.preventDefault();
            if (messageInput.value.trim().length > 0) {
                messageForm.dispatchEvent(new Event('submit'));
            }
        }
    });

    // --- –§–£–ù–ö–¶–Ü–Ø –ú–ê–õ–Æ–í–ê–ù–ù–Ø –ú–û–ì–û –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ---
    function appendSentMessage(data) {
        const row = document.createElement("div");
        row.className = "message-row sent";
        if (data.id) row.setAttribute('data-message-id', data.id);

        const msg = document.createElement("div");
        msg.className = "message sent";

        if (data.content) {
            const p = document.createElement("p");
            p.textContent = data.content;
            msg.appendChild(p);
        }

        const time = document.createElement("span");
        time.className = "timestamp";
        time.textContent = data.timestamp;
        msg.appendChild(time);

        const avatar = document.createElement("img");
        avatar.src = currentUser.avatar;
        avatar.className = "chat-avatar profile-trigger";

        // Data attrs
        avatar.dataset.username = currentUser.username;
        avatar.dataset.avatarUrl = currentUser.avatar;
        avatar.dataset.bio = currentUser.bio;
        avatar.dataset.phone = currentUser.phone;
        avatar.dataset.profileUrl = currentUser.url;

        row.appendChild(msg);
        row.appendChild(avatar);
        messageList.appendChild(row);
        scrollToBottom();
        avatar.addEventListener("click", openProfilePopup);
    }

    // --- –§–£–ù–ö–¶–Ü–Ø –ú–ê–õ–Æ–í–ê–ù–ù–Ø –ß–£–ñ–û–ì–û –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ---
    function appendIncomingMessage(data) {
        if (document.querySelector(`[data-message-id="${data.id}"]`)) return;

        const row = document.createElement("div");
        row.className = "message-row received";
        row.setAttribute('data-message-id', data.id);

        const avatarImg = document.createElement("img");
        avatarImg.src = data.avatar;
        avatarImg.className = "chat-avatar profile-trigger";

        avatarImg.dataset.username = data.sender;
        avatarImg.dataset.avatarUrl = data.avatar;
        avatarImg.dataset.bio = data.bio;
        avatarImg.dataset.phone = data.phone;
        avatarImg.dataset.profileUrl = data.profile_url;
        avatarImg.addEventListener("click", openProfilePopup);

        const msgDiv = document.createElement("div");
        msgDiv.className = "message received";

        const strong = document.createElement("strong");
        strong.textContent = data.sender + ": ";
        msgDiv.appendChild(strong);

        if (data.content) {
            const p = document.createElement("p");
            p.textContent = data.content;
            msgDiv.appendChild(p);
        }

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = data.timestamp;
        msgDiv.appendChild(timeSpan);

        row.appendChild(avatarImg);
        row.appendChild(msgDiv);
        messageList.appendChild(row);
        scrollToBottom();
    }

    // ============================================================
    // 4. –ü–û–ü–ê–ü –ü–†–û–§–Ü–õ–Æ (–¢–≤—ñ–π –∫–æ–¥)
    // ============================================================
    const profilePopup = document.getElementById("profilePopup");
    const closeProfileBtn = document.getElementById("closeProfileBtn");
    const popupAvatar = document.getElementById("popup-avatar");
    const popupUsername = document.getElementById("popup-username");
    const popupBio = document.getElementById("popup-bio");
    const popupBioWrapper = document.getElementById("popup-bio-wrapper");
    const popupPhone = document.getElementById("popup-phone");
    const popupPhoneWrapper = document.getElementById("popup-phone-wrapper");
    const popupProfileLink = document.getElementById("popup-profile-link");

    function openProfilePopup(e) {
        const el = e.currentTarget;
        const bio = el.dataset.bio || "";
        const phone = el.dataset.phone || "";

        popupAvatar.src = el.dataset.avatarUrl || el.src;
        popupUsername.textContent = el.dataset.username;
        popupBio.textContent = bio;
        popupPhone.textContent = phone;
        popupProfileLink.href = el.dataset.profileUrl;

        popupBioWrapper.style.display = bio ? "block" : "none";
        popupPhoneWrapper.style.display = phone ? "block" : "none";
        profilePopup.style.display = "flex";
    }

    function closeProfile() {
        profilePopup.style.display = "none";
    }

    closeProfileBtn.addEventListener("click", closeProfile);
    profilePopup.addEventListener("click", e => {
        if (e.target === profilePopup) closeProfile();
    });

    document.querySelectorAll(".profile-trigger").forEach(el => el.addEventListener("click", openProfilePopup));

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    scrollToBottom();
    updateMessageInputHeight();
});
</script>
{% endblock %}