{% extends "main/layout.html" %}
{% load static %}

{% block content %}
<script id="chat-script"
        data-chat-id="{{ chat_room.id }}"
        data-user-avatar="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
        defer>
    // –°—é–¥–∏ –±—É–¥–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–∏–π –≤–∞—à JavaScript
</script>

<div class="chat-container">

    <div class="chat-header">

        <div class="chat-header-info">
            <h3>–ß–∞—Ç –∑ {{ other_user.username }}</h3>
            <p>—â–æ–¥–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è: **{{ chat_room.ad.title }}**</p>
        </div>

        <a href="{% url 'chat_list' %}" class="chat-back-link">
            <i class="fas fa-arrow-left me-1"></i> –ù–∞–∑–∞–¥ –¥–æ –≤—Å—ñ—Ö —á–∞—Ç—ñ–≤
        </a>
    </div>

    <a href="{% url 'ad_detail' slug=chat_room.ad.slug %}" class="text-decoration-none">
        <div class="card ad-listing-card mb-0 shadow-sm" style="border-radius: 0; border: none; border-bottom: 1px solid #e9ecef;">
            <div class="row g-0">
                <div class="col-3">
                    <img src="{% if chat_room.ad.images.first %}{{ chat_room.ad.images.first.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="ad-listing-img"
                         style="height: 100%; border-radius: 0; object-fit: cover;" alt="{{ chat_room.ad.title }}">
                </div>
                <div class="col-9">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h5 class="card-title mb-0">
                                <span class="text-dark">
                                    {{ chat_room.ad.title|truncatechars:35 }}
                                </span>
                            </h5>
                            <h4 class="text-dark fw-bold mb-0 ms-2" style="font-size: 1rem;">
                                {{ chat_room.ad.price|floatformat:0 }} –≥—Ä–Ω
                            </h4>
                        </div>
                        <p class="card-text text-muted small mb-0">
                            <i class="fa-solid fa-location-dot me-1"></i>
                            {{ chat_room.ad.place|default:"–ú—ñ—Å—Ü–µ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ" }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </a>

    <div class="message-list" id="message-list">
        {% for message in messages %}
            {% if message.sender == request.user %}
                <div class="message-row sent" data-message-id="{{ message.id }}">
                    <div class="message sent">
                        {% if message.file %}
                            {% with filename=message.file.name|default:"–§–∞–π–ª" %}
                                {% if filename|lower|slice:"-4:" == ".jpg" or filename|lower|slice:"-5:" == ".jpeg" or filename|lower|slice:"-4:" == ".png" or filename|lower|slice:"-4:" == ".gif" %}
                                    <a href="{{ message.file.url }}" target="_blank">
                                        <img src="{{ message.file.url }}" class="chat-message-image" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è">
                                    </a>
                                {% else %}
                                    <a href="{{ message.file.url }}" target="_blank" class="file-link">
                                        <i class="fas fa-file me-2"></i> [–§–∞–π–ª: {{ filename|slice:"-20:" }}]
                                    </a>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        {% if message.content %}<p>{{ message.content }}</p>{% endif %}
                        <span class="timestamp">{{ message.timestamp|date:"d.m H:i" }}</span>
                    </div>

                    <img src="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="chat-avatar profile-trigger"
                         alt="Avatar"
                         data-username="{{ request.user.username }}"
                         data-avatar-url="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         data-bio="{{ request.user.profile.bio|default:'' }}"
                         data-phone="{{ request.user.profile.phone|default:'' }}"
                         data-profile-url="{% url 'my_profile' %}">
                </div>

            {% else %}
                <div class="message-row received" data-message-id="{{ message.id }}">

                    <img src="{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         class="chat-avatar profile-trigger"
                         alt="Avatar"
                         data-username="{{ other_user.username }}"
                         data-avatar-url="{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         data-bio="{{ other_user.profile.bio|default:'' }}"
                         data-phone="{{ other_user.profile.phone|default:'' }}"
                         data-profile-url="{% url 'public_profile' username=other_user.username %}">

                    <div class="message received">
                        <strong>{{ message.sender.username }}:</strong>
                        {% if message.file %}
                            {% with filename=message.file.name|default:"–§–∞–π–ª" %}
                                {% if filename|lower|slice:"-4:" == ".jpg" or filename|lower|slice:"-5:" == ".jpeg" or filename|lower|slice:"-4:" == ".png" or filename|lower|slice:"-4:" == ".gif" %}
                                    <a href="{{ message.file.url }}" target="_blank">
                                        <img src="{{ message.file.url }}" class="chat-message-image" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è">
                                    </a>
                                {% else %}
                                    <a href="{{ message.file.url }}" target="_blank" class="file-link">
                                        <i class="fas fa-file me-2"></i> [–§–∞–π–ª: {{ filename|slice:"-20:" }}]
                                    </a>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        {% if message.content %}<p>{{ message.content }}</p>{% endif %}
                        <span class="timestamp">{{ message.timestamp|date:"d.m H:i" }}</span>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="chat-input-area">
        <form id="message-form" class="message-form" enctype="multipart/form-data">
            {% csrf_token %}



            <div class="message-input-wrapper">
                <div id="file-preview" class="file-preview-inline"></div>

                <textarea id="message-input" name="content" class="form-control" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
            </div>

            <div class="message-form-right-controls">

                <button type="submit" class="icon-btn send-btn">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
        </form>
    </div>

</div>

<div id="profilePopup" class="profile-popup-overlay" style="display: none;">
  <div class="edit-profile-card fade-in">
    <h2><i class="fa-solid fa-user" style="color: #3a1a30"></i> –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
    <div class="profile-view">
      <div class="avatar-section">
        <img src="" id="popup-avatar" class="profile-avatar-preview" alt="Avatar">
      </div>
      <div class="form-group">
        <label>–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
        <p id="popup-username"></p>
      </div>
      <div class="form-group" id="popup-bio-wrapper" style="display: none;">
        <label>–ü—Ä–æ —Å–µ–±–µ</label>
        <p id="popup-bio"></p>
      </div>
      <div class="form-group" id="popup-phone-wrapper" style="display: none;">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <p id="popup-phone"></p>
      </div>
      <div class="profile-buttons">
          <a href="#" id="popup-profile-link" class="btn btn-secondary">
              <i class="fa-solid fa-user-circle"></i> –ü–æ–≤–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
          </a>
          <button id="closeProfileBtn" class="btn btn-gradient">
              <i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥
          </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // ============================================================
    // 0. –ì–û–õ–û–í–ù–Ü –ó–ú–Ü–ù–ù–Ü
    // ============================================================
    const scriptTag = document.getElementById("chat-script");
    const chatId = scriptTag.dataset.chatId;
    const userAvatar = scriptTag.dataset.userAvatar;

    const messageList = document.getElementById("message-list");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.querySelector(".send-btn");
    const csrf = document.querySelector("input[name='csrfmiddlewaretoken']").value;

    // –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –§–ê–ô–õ–Ü–í –¢–ê –ì–û–õ–û–°–£ –í–ò–î–ê–õ–ï–ù–û

    // –î–∞–Ω—ñ —é–∑–µ—Ä–∞
    const currentUser = {
        username: "{{ request.user.username }}",
        avatar: userAvatar,
        bio: "{{ request.user.profile.bio|default:'' }}",
        phone: "{{ request.user.profile.phone|default:'' }}",
        url: "{% url 'my_profile' %}"
    };

    // –î–∞–Ω—ñ —ñ–Ω—à–æ–≥–æ —é–∑–µ—Ä–∞
    const otherUser = {
        username: "{{ other_user.username }}",
        avatar: "{% if other_user.profile.image %}{{ other_user.profile.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}",
        bio: "{{ other_user.profile.bio|default:'' }}",
        phone: "{{ other_user.profile.phone|default:'' }}",
        url: "{% url 'public_profile' username=other_user.username %}"
    };


    // ============================================================
    // 0.5. –§–£–ù–ö–¶–Ü–Ø –°–∫—Ä–æ–ª—É –≤ –∫—ñ–Ω–µ—Ü—å
    // ============================================================
    function scrollToBottom() {
        messageList.scrollTop = messageList.scrollHeight;
    }


// ============================================================
// 1. –§–£–ù–ö–¶–Ü–Ø –î–û–î–ê–í–ê–ù–ù–Ø –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ (–í–Ü–î –°–ï–ë–ï)
// ============================================================
function appendSentMessage(data) {

    // 1. –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä—è–¥–∫–∞
    const row = document.createElement("div");
    row.className = "message-row sent";

    // üî• –í–ê–ñ–õ–ò–í–û: –î–æ–¥–∞—î–º–æ ID, —â–æ–± —Å–∫—Ä–∏–ø—Ç –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (polling) –±–∞—á–∏–≤,
    // —â–æ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∂–µ —î –Ω–∞ –µ–∫—Ä–∞–Ω—ñ, —ñ –Ω–µ –¥–æ–¥–∞–≤–∞–≤ –π–æ–≥–æ –≤–¥—Ä—É–≥–µ.
    if (data.id) {
        row.setAttribute('data-message-id', data.id);
    }

    // 2. ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û: –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ —Å–∞–º–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ä–∞–Ω—ñ—à–µ –π–æ–≥–æ –Ω–µ –±—É–ª–æ)
    const msg = document.createElement("div");
    msg.className = "message sent";

    // 3. –ù–∞–ø–æ–≤–Ω—é—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
    if (data.content) {
        const p = document.createElement("p");
        p.textContent = data.content;
        msg.appendChild(p);
    }

    // –î–æ–¥–∞—î–º–æ —á–∞—Å
    const time = document.createElement("span");
    time.className = "timestamp";
    time.textContent = data.timestamp;
    msg.appendChild(time);

    // 4. –°—Ç–≤–æ—Ä—é—î–º–æ –∞–≤–∞—Ç–∞—Ä
    const avatar = document.createElement("img");
    avatar.src = currentUser.avatar;
    avatar.className = "chat-avatar profile-trigger";
    avatar.alt = "Avatar";

    // –ü—Ä–∏—Å–≤–æ—î–Ω–Ω—è data-–∞—Ç—Ä–∏–±—É—Ç—ñ–≤ –¥–ª—è –ø–æ–ø–∞–ø—É –ø—Ä–æ—Ñ—ñ–ª—é
    avatar.dataset.username = currentUser.username;
    avatar.dataset.avatarUrl = currentUser.avatar;
    avatar.dataset.bio = currentUser.bio;
    avatar.dataset.phone = currentUser.phone;
    avatar.dataset.profileUrl = currentUser.url;

    // 5. –ó–±–∏—Ä–∞—î–º–æ –≤—Å–µ —Ä–∞–∑–æ–º
    row.appendChild(msg);    // –°–ø–æ—á–∞—Ç–∫—É —Ç–µ–∫—Å—Ç
    row.appendChild(avatar); // –ü–æ—Ç—ñ–º –∞–≤–∞—Ç–∞—Ä (–±–æ —Ü–µ sent)

    // 6. –í–∏–≤–æ–¥–∏–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω
    messageList.appendChild(row);
    scrollToBottom();

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –Ω–æ–≤–æ–º—É –∞–≤–∞—Ç–∞—Ä—ñ
    avatar.addEventListener("click", openProfilePopup);
}

    // ============================================================
    // 2. –ü–û–ü–ê–ü –ü–†–û–§–Ü–õ–Æ
    // ============================================================
    const profilePopup = document.getElementById("profilePopup");
    const closeProfileBtn = document.getElementById("closeProfileBtn");

    const popupAvatar = document.getElementById("popup-avatar");
    const popupUsername = document.getElementById("popup-username");
    const popupBio = document.getElementById("popup-bio");
    const popupBioWrapper = document.getElementById("popup-bio-wrapper");
    const popupPhone = document.getElementById("popup-phone");
    const popupPhoneWrapper = document.getElementById("popup-phone-wrapper");
    const popupProfileLink = document.getElementById("popup-profile-link");

    function openProfilePopup(e) {
        const el = e.currentTarget;

        const bio = el.dataset.bio || "";
        const phone = el.dataset.phone || "";

        popupAvatar.src = el.dataset.avatarUrl || el.src;
        popupUsername.textContent = el.dataset.username;
        popupBio.textContent = bio;
        popupPhone.textContent = phone;
        popupProfileLink.href = el.dataset.profileUrl;

        // –ü–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ –±–ª–æ–∫–∏ –±—ñ–æ —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
        popupBioWrapper.style.display = bio ? "block" : "none";
        popupPhoneWrapper.style.display = phone ? "block" : "none";

        profilePopup.style.display = "flex";
    }

    function closeProfile() {
        profilePopup.style.display = "none";
    }

    // –î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –∫–ª—ñ–∫—ñ–≤ –¥–ª—è –ø–æ–ø–∞–ø—É
    closeProfileBtn.addEventListener("click", closeProfile);
    profilePopup.addEventListener("click", e => {
        if (e.target === profilePopup) closeProfile();
    });

    document.querySelectorAll(".profile-trigger")
        .forEach(el => el.addEventListener("click", openProfilePopup));

    // ============================================================
    // 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê –í–ò–°–û–¢–ê –ü–û–õ–Ø –í–í–û–î–£
    // ============================================================
    // ============================================================
    // 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê –í–ò–°–û–¢–ê –ü–û–õ–Ø –í–í–û–î–£ + –í–Ü–î–ü–†–ê–í–ö–ê –ü–û ENTER
    // ============================================================
    function updateMessageInputHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
        messageInput.style.paddingTop = "8px";
    }

    // –û–±—Ä–æ–±–∫–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∑–º—ñ–Ω–∏ –≤–∏—Å–æ—Ç–∏ –ø–æ–ª—è
    messageInput.addEventListener('input', updateMessageInputHeight);

    // üöÄ –ù–û–í–ê –õ–û–ì–Ü–ö–ê: –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –ü–†–ò –ù–ê–¢–ò–°–ö–ê–ù–ù–Ü ENTER
    messageInput.addEventListener('keydown', (e) => {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –±—É–ª–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞ –∫–ª–∞–≤—ñ—à–∞ Enter
        if (e.key === 'Enter') {

            // –Ø–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ SHIFT+ENTER –∞–±–æ CTRL+ENTER, –º–∏ –¥–æ–∑–≤–æ–ª—è—î–º–æ
            // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É (–ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫)
            if (e.shiftKey || e.ctrlKey) {
                return;
            }

            // –Ø–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ –ø—Ä–æ—Å—Ç–æ Enter:
            e.preventDefault(); // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É (–Ω–æ–≤–∏–π —Ä—è–¥–æ–∫)

            // –Ü–º—ñ—Ç—É—î–º–æ –∫–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ submit —É —Ñ–æ—Ä–º–∏
            if (messageInput.value.trim().length > 0) {
                messageForm.dispatchEvent(new Event('submit'));
            }
        }
    });

    // ============================================================
    // 4. –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (FIXED)
    // ============================================================
    if (messageForm) {
        messageForm.addEventListener("submit", e => {
            e.preventDefault();

            const text = messageInput.value.trim();

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —î —Ç–µ–∫—Å—Ç
            if (!text) return;

            // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
            sendButton.disabled = true;
            messageInput.disabled = true;

            const fd = new FormData();
            fd.append("content", text);
            // CSRF —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –≤ —Ç—ñ–ª—ñ, –∞–ª–µ –∫—Ä–∞—â–µ —ñ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö (–¥–∏–≤. –Ω–∏–∂—á–µ)
            fd.append("csrfmiddlewaretoken", csrf);

            fetch(`/my-chats/${chatId}/`, {
                method: "POST",
                headers: {
                    // üî• –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û: –¶–µ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∂–µ Django –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ JSON, –∞ –Ω–µ HTML
                    "X-Requested-With": "XMLHttpRequest",
                    // –î–æ–¥–∞—î–º–æ CSRF —Ç–æ–∫–µ–Ω —Ç–∞–∫–æ–∂ —É –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
                    "X-CSRFToken": csrf
                },
                body: fd
            })
            .then(async response => {
                // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø—Ä–∏–π—à–æ–≤ JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    // –Ø–∫—â–æ —Ü–µ JSON ‚Äî –ø–∞—Ä—Å–∏–º–æ
                    return response.json().then(data => {
                        if (!response.ok) {
                            // –Ø–∫—â–æ —Å—Ç–∞—Ç—É—Å –Ω–µ 200, –∞–ª–µ —Ü–µ JSON (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, validation error)
                            return Promise.reject(data);
                        }
                        return data;
                    });
                } else {
                    // –Ø–∫—â–æ –ø—Ä–∏–π—à–æ–≤ HTML (–ø–æ–º–∏–ª–∫–∞ 500 –∞–±–æ 404, –∞–±–æ —Ä–µ–¥—ñ—Ä–µ–∫—Ç)
                    const text = await response.text();
                    console.error("–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ JSON:", text);
                    throw new Error("–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ HTML –∑–∞–º—ñ—Å—Ç—å JSON. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–±–æ –ª–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞.");
                }
            })
            .then(data => {
                // –£—Å–ø—ñ—à–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞
                if (data.status === "ok") {
                    // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—è–∫—â–æ —É –≤–∞—Å —î —Ñ—É–Ω–∫—Ü—ñ—è appendSentMessage)
                    // –Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ WebSocket –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —Ü–µ–π —Ä—è–¥–æ–∫ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω,
                    // –∞–ª–µ –¥–ª—è –º–∏—Ç—Ç—î–≤–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –º–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏.
                    if (typeof appendSentMessage === "function") {
                        appendSentMessage(data);
                    }

                    messageInput.value = "";
                    if (typeof updateMessageInputHeight === "function") {
                        updateMessageInputHeight();
                    }
                } else {
                    alert(`–ü–æ–º–∏–ª–∫–∞: ${data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.'}`);
                }
            })
            .catch(err => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—ñ:", err);
                // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏–π—à–ª–∞ –≤—ñ–¥ –Ω–∞—à–æ–≥–æ Promise.reject(data)
                if (err.message) {
                     alert(`–ü–æ–º–∏–ª–∫–∞: ${err.message}`);
                } else {
                     alert("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑'—î–¥–Ω–∞–Ω–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.");
                }
            })
            .finally(() => {
                // –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            });
        });
    }

    // ============================================================
    // 5. –î–û–î–ê–¢–ö–û–í–Ü –ö–û–ù–¢–†–û–õ–ï–†–ò (–í–∏–¥–∞–ª–µ–Ω–æ)
    // ============================================================

    // ============================================================
    // 6. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    // ============================================================

    scrollToBottom();
    updateMessageInputHeight();
    // ==========================================
    // –õ–û–ì–Ü–ö–ê –û–¢–†–ò–ú–ê–ù–ù–Ø –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ (REAL-TIME)
    // ==========================================

    // 1. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    function appendIncomingMessage(data) {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        if (document.querySelector(`[data-message-id="${data.id}"]`)) return;

        const row = document.createElement("div");
        // –Ø–∫—â–æ —Ü–µ –º–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–≤—ñ–¥–∫—Ä–∏—Ç–µ –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ) -> sent, —è–∫—â–æ —á—É–∂–µ -> received
        row.className = data.is_me ? "message-row sent" : "message-row received";
        row.setAttribute('data-message-id', data.id);

        // –°—Ç–≤–æ—Ä—é—î–º–æ –∞–≤–∞—Ç–∞—Ä
        const avatarImg = document.createElement("img");
        avatarImg.src = data.avatar;
        avatarImg.className = "chat-avatar profile-trigger";
        // –î–∞–Ω—ñ –¥–ª—è –ø–æ–ø–∞–ø—É
        avatarImg.dataset.username = data.sender;
        avatarImg.dataset.avatarUrl = data.avatar;
        avatarImg.dataset.bio = data.bio;
        avatarImg.dataset.phone = data.phone;
        avatarImg.dataset.profileUrl = data.profile_url;

        // –î–æ–¥–∞—î–º–æ –∫–ª—ñ–∫ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (—â–æ–± –≤—ñ–¥–∫—Ä–∏–≤–∞–≤ –ø—Ä–æ—Ñ—ñ–ª—å)
        avatarImg.addEventListener("click", openProfilePopup);

        // –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ –∑ —Ç–µ–∫—Å—Ç–æ–º
        const msgDiv = document.createElement("div");
        msgDiv.className = data.is_me ? "message sent" : "message received";

        // –Ü–º'—è (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —á—É–∂–∏—Ö)
        if (!data.is_me) {
            const strong = document.createElement("strong");
            strong.textContent = data.sender + ": ";
            msgDiv.appendChild(strong);
        }

        // –Ø–∫—â–æ —î —Ñ–∞–π–ª
        if (data.file_url) {
             const fileLink = document.createElement("a");
             fileLink.href = data.file_url;
             fileLink.target = "_blank";

             if (/\.(jpg|jpeg|png|gif)$/i.test(data.file_name)) {
                 const img = document.createElement("img");
                 img.src = data.file_url;
                 img.className = "chat-message-image";
                 fileLink.appendChild(img);
             } else {
                 fileLink.className = "file-link";
                 fileLink.innerHTML = `<i class="fas fa-file me-2"></i> [–§–∞–π–ª: ${data.file_name}]`;
             }
             msgDiv.appendChild(fileLink);
        }

        // –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        if (data.content) {
            const p = document.createElement("p");
            p.textContent = data.content;
            msgDiv.appendChild(p);
        }

        // –ß–∞—Å
        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = data.timestamp;
        msgDiv.appendChild(timeSpan);

        // –ó–±–∏—Ä–∞—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–ø–æ—Ä—è–¥–æ–∫ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–æ–≥–æ, —Ö—Ç–æ –ø–∏—Å–∞–≤)
        if (data.is_me) {
            row.appendChild(msgDiv);
            row.appendChild(avatarImg);
        } else {
            row.appendChild(avatarImg);
            row.appendChild(msgDiv);
        }

        // –î–æ–¥–∞—î–º–æ –≤ —á–∞—Ç
        messageList.appendChild(row);
        scrollToBottom();
    }

    // 2. –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è: –∑–Ω–∞–π—Ç–∏ ID –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    function getLastMessageId() {
        const rows = document.querySelectorAll('.message-row');
        if (rows.length === 0) return 0;
        const lastRow = rows[rows.length - 1];
        // –Ø–∫—â–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –Ω–µ–º–∞—î, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 0
        return lastRow.getAttribute('data-message-id') || 0;
    }

    // 3. –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê (–ö–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏)
    setInterval(() => {
        const lastId = getLastMessageId();

        // –ó–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ API, —è–∫–µ –º–∏ –ø—Ä–æ–ø–∏—Å–∞–ª–∏ –≤ api/urls.py
        fetch(`/api/get_messages/${chatId}/?last_id=${lastId}`)
            .then(response => {
                if (!response.ok) return null;
                return response.json();
            })
            .then(data => {
                if (data && data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        appendIncomingMessage(msg);
                    });
                }
            })
            .catch(err => console.error("Chat update error:", err));

    }, 2000);
});
</script>
{% endblock %}