{% extends "main/layout.html" %}
{% load static %}

{% block content %}
<div class="chat-list-page-container">

    <h1>–ú–æ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h1>

    <h3>–ù–ï–ü–†–û–ß–ò–¢–ê–ù–Ü</h3>

    <div id="unread-container" class="chat-list-container {% if not unread_chats %}d-none{% endif %}">
        {% for chat in unread_chats %}
            {% include 'myapp/chat_list_item.html' with chat=chat unread=True %}
        {% endfor %}
    </div>

    <div id="unread-empty-msg" class="chat-list-empty {% if unread_chats %}d-none{% endif %}">
        <p>üéâ –í–∏ –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏!</p>
    </div>

    <hr>

    <h3>–ü–†–û–ß–ò–¢–ê–ù–Ü</h3>

    <div id="read-container" class="chat-list-container">
        {% for chat in read_chats %}
            {% include 'myapp/chat_list_item.html' with chat=chat unread=False %}
        {% endfor %}
    </div>

    {% if not read_chats %}
         <div class="chat-list-empty">
            <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö —á–∞—Ç—ñ–≤.</p>
        </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    window.updateChatList = function(data) {
        console.log("‚ö° –û–Ω–æ–≤–ª—é—é —á–∞—Ç —É —Å–ø–∏—Å–∫—É:", data);

        // 1. –®—É–∫–∞—î–º–æ —á–∞—Ç. –í–ê–ñ–õ–ò–í–û: –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤ chat_list_item.html —î –∞—Ç—Ä–∏–±—É—Ç data-sender
        const chatItem = document.querySelector(`.chat-item[data-sender="${data.sender}"]`);

        const unreadContainer = document.getElementById('unread-container');
        const emptyMsg = document.getElementById('unread-empty-msg');

        if (chatItem) {
            // 2. –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç
            const msgPreview = chatItem.querySelector('.chat-item-message');
            if (msgPreview) msgPreview.textContent = data.content;

            // 3. –†–æ–±–∏–º–æ —Å—Ç–∏–ª—å "–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏–π"
            // (–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —É –≤–∞—Å —î CSS –¥–ª—è —Ü—å–æ–≥–æ –∫–ª–∞—Å—É, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ 'fw-bold')
            chatItem.classList.add('chat-item-unread');

            // 4. –ü–ï–†–ï–ú–Ü–©–ï–ù–ù–Ø –í–ì–û–†–£
            if (unreadContainer) {
                // –Ø–∫—â–æ –±–ª–æ–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –±—É–≤ —Å—Ö–æ–≤–∞–Ω–∏–π - –ø–æ–∫–∞–∑—É—î–º–æ –π–æ–≥–æ
                unreadContainer.classList.remove('d-none');

                // –•–æ–≤–∞—î–º–æ –Ω–∞–ø–∏—Å "–í–∏ –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏"
                if (emptyMsg) emptyMsg.classList.add('d-none');

                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ —Å–∞–º –µ–ª–µ–º–µ–Ω—Ç —á–∞—Ç—É –≤ –ø–æ—á–∞—Ç–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö
                unreadContainer.prepend(chatItem);
            }

            // 5. üî• –ï–§–ï–ö–¢ –°–í–Ü–¢–Ü–ù–ù–Ø üî•
            // –í–∏–¥–∞–ª—è—î–º–æ –∫–ª–∞—Å, —è–∫—â–æ –≤—ñ–Ω —Ä–∞–ø—Ç–æ–º –≤–∂–µ –±—É–≤ (—â–æ–± –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é)
            chatItem.classList.remove('flash-highlight');

            // –ú–∞–ª–µ–Ω—å–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –±—Ä–∞—É–∑–µ—Ä –∑—Ä–æ–∑—É–º—ñ–≤, —â–æ –∫–ª–∞—Å –±—É–ª–æ –∑–Ω—è—Ç–æ —ñ –¥–æ–¥–∞–Ω–æ –∑–Ω–æ–≤—É
            void chatItem.offsetWidth; // –¢—Ä—é–∫ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É CSS –∞–Ω—ñ–º–∞—Ü—ñ—ó

            chatItem.classList.add('flash-highlight');

            // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–ª–∞—Å —á–µ—Ä–µ–∑ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó
            setTimeout(() => {
                chatItem.classList.remove('flash-highlight');
            }, 1500);

        } else {
            // –Ø–∫—â–æ —Ü–µ –Ω–æ–≤–∏–π —á–∞—Ç, —è–∫–æ–≥–æ –Ω–µ–º–∞ –≤ DOM - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
            console.log("–ù–æ–≤–∏–π —á–∞—Ç, –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é —Å—Ç–æ—Ä—ñ–Ω–∫—É...");
            location.reload();
        }
    };
</script>

<style>
    /* –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–≤—ñ—Ç—ñ–Ω–Ω—è */
    @keyframes flashGlow {
        0% { background-color: rgba(220, 53, 69, 0.0); }
        20% { background-color: rgba(220, 53, 69, 0.2); } /* –°–ø–∞–ª–∞—Ö */
        100% { background-color: transparent; }
    }

    .flash-highlight {
        animation: flashGlow 1.5s ease-out;
    }
</style>
{% endblock %}