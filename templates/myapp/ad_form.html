{% extends 'main/layout.html' %}
{% load static %}

{% block title %}Створити оголошення{% endblock %}

{% block content %}
    <div class="container-fluid create-ad-container">
        {% if is_edit %}
        <h1 class="h2 mb-4">Редагувати оголошення</h1>
    {% else %}
        <h1 class="h2 mb-4">Створити оголошення</h1>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">Опишіть у подробицях</h5>
            </div>
            <div class="card-body">

                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">Вкажіть назву*</label>
                    {{ form.title }}
                    <div class="form-text">Наприклад, iPhone 11 з гарантією</div>
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.price.id_for_label }}" class="form-label">Ціна*</label>
                    <div class="input-group">
                        {{ form.price }}
                        <span class="input-group-text">грн</span>
                    </div>
                    {% if form.price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.price.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>



                {# --- ПОЧАТОК БЛОКУ ДЛЯ ФОТО --- #}
        {# --- ПОЧАТОК НОВОГО БЛОКУ ДЛЯ ФОТО (GRID) --- #}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">Фото (до 7 шт.)</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">Перше фото буде на обкладинці оголошення. Перетягніть, щоб змінити порядок фото.</p>

        {{ formset.management_form }} {# Required for formset #}

        <div class="row g-3 ad-image-grid"> {# g-3 adds gaps between columns #}
            {% for image_form in formset %}
                <div class="col-6 col-md-4 col-lg-3"> {# Adjust columns per screen size (2 on mobile, 3 on tablet, 4 on desktop) #}
                    <div class="ad-image-placeholder">
                        <label for="{{ image_form.image.id_for_label }}" class="ad-image-label">
                            {# Display a preview if image is already uploaded (for editing) #}
                            {% if image_form.instance.pk and image_form.instance.image %}
                                <img src="{{ image_form.instance.image.url }}" class="ad-image-preview" alt="Preview">
                                <span class="ad-image-delete">
                                    {% if image_form.DELETE %} {{ image_form.DELETE }} Видалити {% endif %}
                                </span>
                            {% else %}
                                {# Placeholder icon and text for the first empty slot #}
                                {% if forloop.first and not image_form.initial %}
                                <div class="add-photo-text">
                                    <i class="fa-solid fa-camera fa-2x mb-2"></i>
                                    <span>Додати фото</span>
                                </div>
                                {% else %}
                                <i class="fa-solid fa-camera placeholder-icon"></i>
                                {% endif %}
                            {% endif %}
                            {# The actual file input, visually hidden but active #}
                            {{ image_form.image }}
                        </label>
                        {% if image_form.image.errors %}
                            <div class="invalid-feedback d-block mt-1">
                                {% for error in image_form.image.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                         {% comment %} Render hidden ID field for existing images {% endcomment %}
                         {% if image_form.instance.pk %}{{ image_form.id }}{% endif %}
                    </div>
                </div>
            {% endfor %}
        </div> {# End row #}
    </div>
</div>
{# --- КІНЕЦЬ НОВОГО БЛОКУ ДЛЯ ФОТО (GRID) --- #}
        {# --- КІНЕЦЬ БЛОКУ ДЛЯ ФОТО --- #}



        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">Опис*</h5>
            </div>
            <div class="card-body">
                <label for="{{ form.body.id_for_label }}" class="form-label d-none">Опис</label> {# Прихований label #}
                {{ form.body }}
                <div class="form-text">Подумайте, що хотів би дізнатися покупець.</div>
                {% if form.body.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.body.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">Місцезнаходження*</h5>
            </div>
            <div class="card-body">
                <label for="{{ form.place.id_for_label }}" class="form-label d-none">Місцезнаходження</label> {# Прихований label #}
                {{ form.place }}
                {% if form.place.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.place.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">Ваші контактні дані</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Email-адреса</label>
                    <input type="email" class="form-control" value="{{ request.user.email }}" disabled readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Номер телефону</label>
                    <input type="text" class="form-control" value="Ваш номер" disabled readonly>
                    </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-end gap-2">
                <a href="#" class="btn btn-outline-dark btn-lg">Попередній перегляд</a>
                <button type="submit" class="btn btn-primary-dark btn-lg">Опублікувати</button>
            </div>
        </div>
    </form>
</div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all the file input elements within the image grid
        const imageInputs = document.querySelectorAll('.ad-image-grid input[type="file"]');

        imageInputs.forEach(input => {
            input.addEventListener('change', function(event) {
                const file = event.target.files[0];
                const placeholderDiv = input.closest('.ad-image-placeholder'); // Find the parent square
                const label = placeholderDiv.querySelector('.ad-image-label'); // Find the label inside

                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        // Remove existing content (icon or previous preview)
                        label.innerHTML = '';

                        // Create an img element for the preview
                        const imgPreview = document.createElement('img');
                        imgPreview.src = e.target.result;
                        imgPreview.classList.add('ad-image-preview'); // Use the same class as in CSS
                        imgPreview.alt = 'Preview';

                        // Add the preview image inside the label
                        label.appendChild(imgPreview);

                        // IMPORTANT: Re-append the hidden file input so it still submits
                        label.appendChild(input);
                    }

                    // Read the image file as a data URL
                    reader.readAsDataURL(file);
                } else {
                    // Optional: Handle cases where the selected file is not an image
                    // You could clear the preview or show an error message
                    console.log("Selected file is not an image or no file selected.");
                     // Clear preview if needed - find and remove existing imgPreview if any
                     const existingPreview = label.querySelector('.ad-image-preview');
                     if (existingPreview) {
                         label.removeChild(existingPreview);
                         // You might want to restore the placeholder icon here
                     }
                }
            });
        });
    });
</script>
{% endblock %}