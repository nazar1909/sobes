{% extends 'main/layout.html' %}
{% load static %}

{% block title %}–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è{% endblock %}

{% block content %}
    <div class="container-fluid create-ad-container">
        {% if is_edit %}
        <h1 class="h2 mb-4">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h1>
    {% else %}
        <h1 class="h2 mb-4">–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h1>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—à—ñ—Ç—å —É –ø–æ–¥—Ä–æ–±–∏—Ü—è—Ö</h5>
            </div>
            <div class="card-body">

                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É*</label>
                    {{ form.title }}
                    <div class="form-text">–ù–∞–ø—Ä–∏–∫–ª–∞–¥, iPhone 11 –∑ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é</div>
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.price.id_for_label }}" class="form-label">–¶—ñ–Ω–∞*</label>
                    <div class="input-group">
                        {{ form.price }}
                        <span class="input-group-text">–≥—Ä–Ω</span>
                    </div>
                    {% if form.price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.price.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>



                {# --- –ü–û–ß–ê–¢–û–ö –ë–õ–û–ö–£ –î–õ–Ø –§–û–¢–û --- #}
        {# --- –ü–û–ß–ê–¢–û–ö –ù–û–í–û–ì–û –ë–õ–û–ö–£ –î–õ–Ø –§–û–¢–û (GRID) --- #}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3">
        <h5 class="mb-0">–§–æ—Ç–æ (–¥–æ 7 —à—Ç.)</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">–ü–µ—Ä—à–µ —Ñ–æ—Ç–æ –±—É–¥–µ –Ω–∞ –æ–±–∫–ª–∞–¥–∏–Ω—Ü—ñ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è. –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ —Ñ–æ—Ç–æ.</p>

        {% load widget_tweaks %}

        {# ‚ùå –ö–û–ù–§–õ–Ü–ö–¢: –ü–æ–ª–µ form.image –º–∞—î –±—É—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–æ –∑ AdForm, —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è FormSet #}
        {# {% render_field form.image class+="form-control" %} #}

        {# üü¢ –î–û–î–ê–ù–û: –ü–æ–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è FormSet (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —Ä–æ–±–æ—Ç–∏ FormSet) #}
        {{ formset.management_form }}

        <div class="row g-3 ad-image-grid"> {# g-3 adds gaps between columns #}
            {% for image_form in formset %}
                <div class="col-6 col-md-4 col-lg-3"> {# Adjust columns per screen size (2 on mobile, 3 on tablet, 4 on desktop) #}
                    <div class="ad-image-placeholder">
                        <label for="{{ image_form.image.id_for_label }}" class="ad-image-label">
                            {# Display a preview if image is already uploaded (for editing) #}
                            {% if image_form.instance.pk and image_form.instance.image %}
                                <img src="{{ image_form.instance.image.url }}" class="ad-image-preview" alt="Preview">
                                <span class="ad-image-delete">
                                    {# üü¢ –í–ò–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ–∫–±–æ–∫—Å—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è #}
                                    {% if image_form.DELETE %} {{ image_form.DELETE }} –í–∏–¥–∞–ª–∏—Ç–∏ {% endif %}
                                </span>
                            {% else %}
                                {# Placeholder icon and text for the first empty slot #}
                                {% if forloop.first and not image_form.initial %}
                                <div class="add-photo-text">
                                    <i class="fa-solid fa-camera fa-2x mb-2"></i>
                                    <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                                </div>
                                {% else %}
                                <i class="fa-solid fa-camera placeholder-icon"></i>
                                {% endif %}
                            {% endif %}
                            {# The actual file input, visually hidden but active #}
                            {{ image_form.image }}
                        </label>
                        {% if image_form.image.errors %}
                            <div class="invalid-feedback d-block mt-1">
                                {% for error in image_form.image.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                         {# Render hidden ID field for existing images #}
                         {% if image_form.instance.pk %}{{ image_form.id }}{% endif %}
                    </div>
                </div>
            {% endfor %}
        </div> {# End row #}
    </div>
</div>
{# --- –ö–Ü–ù–ï–¶–¨ –ù–û–í–û–ì–û –ë–õ–û–ö–£ –î–õ–Ø –§–û–¢–û (GRID) --- #}
        {# --- –ö–Ü–ù–ï–¶–¨ –ë–õ–û–ö–£ –î–õ–Ø –§–û–¢–û --- #}



        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–û–ø–∏—Å*</h5>
            </div>
            <div class="card-body">
                <label for="{{ form.body.id_for_label }}" class="form-label d-none">–û–ø–∏—Å</label> {# –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π label #}
                {{ form.body }}
                <div class="form-text">–ü–æ–¥—É–º–∞–π—Ç–µ, —â–æ —Ö–æ—Ç—ñ–≤ –±–∏ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø–æ–∫—É–ø–µ—Ü—å.</div>
                {% if form.body.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.body.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è*</h5>
            </div>
            <div class="card-body">
                <label for="{{ form.place.id_for_label }}" class="form-label d-none">–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è</label> {# –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π label #}
                {{ form.place }}
                {% if form.place.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.place.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">–í–∞—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Email-–∞–¥—Ä–µ—Å–∞</label>
                    <input type="email" class="form-control" value="{{ request.user.email }}" disabled readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
                    <input type="text" class="form-control" value="–í–∞—à –Ω–æ–º–µ—Ä" disabled readonly>
                    </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-end gap-2">
                <a href="#" class="btn btn-outline-dark btn-lg">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</a>
                <button type="submit" class="btn btn-primary-dark btn-lg">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </form>
</div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all the file input elements within the image grid
        const imageInputs = document.querySelectorAll('.ad-image-grid input[type="file"]');

        imageInputs.forEach(input => {
            input.addEventListener('change', function(event) {
                const file = event.target.files[0];
                const placeholderDiv = input.closest('.ad-image-placeholder'); // Find the parent square
                const label = placeholderDiv.querySelector('.ad-image-label'); // Find the label inside

                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        // Remove existing content (icon or previous preview)
                        label.innerHTML = '';

                        // Create an img element for the preview
                        const imgPreview = document.createElement('img');
                        imgPreview.src = e.target.result;
                        imgPreview.classList.add('ad-image-preview'); // Use the same class as in CSS
                        imgPreview.alt = 'Preview';

                        // Add the preview image inside the label
                        label.appendChild(imgPreview);

                        // IMPORTANT: Re-append the hidden file input so it still submits
                        label.appendChild(input);
                    }

                    // Read the image file as a data URL
                    reader.readAsDataURL(file);
                } else {
                    // Optional: Handle cases where the selected file is not an image
                    // You could clear the preview or show an error message
                    console.log("Selected file is not an image or no file selected.");
                     // Clear preview if needed - find and remove existing imgPreview if any
                     const existingPreview = label.querySelector('.ad-image-preview');
                     if (existingPreview) {
                         label.removeChild(existingPreview);
                         // You might want to restore the placeholder icon here
                     }
                }
            });
        });
    });
</script>
{% endblock %}